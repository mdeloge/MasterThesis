<script>
    var stored_response;

    $(document).ready(function () {
        $.ajax({
            type: "GET",
            url: "/register",
            success: function (response) {
                stored_response = response;
                var unique_list = [];

                $.each(response['list'], function(i, elem){
                    if($.inArray(elem['recordName'], unique_list) === -1) unique_list.push(elem['recordName']);
                });

                $.each(unique_list, function (key, value) {
                    //console.log(value);
                    $('#business-drop').append('<option value="' + value + '">' + value + '</option>');
                });
                $('select').material_select();
            }
        });
        $('select').material_select();
        $('#register-modal').modal();
    });

    $('#client').click(function () {
        $('#business-div').show();
    });

    $('#analyst').click(function () {
        $('#business-div').hide();
    });

    $('#register-button').click(function () {
        // Get the form inputs' values by ID.
        var email = $('#user_email').val();
        var password = $('#password').val();
        var name = $('#name').val();
        var role = $('input[name=group1]:checked').val();
        var business = $('#business-drop').val();
        var sensor_data = "";
        if (business != "") {
            $.each(stored_response['list'], function (key, value) {
                if (value['recordName'] == business) {
                    sensor_data += value['meterId'] + ";" + value['sensorType'] + "|";
                }
            })
        }
        console.log(sensor_data);

        var register_button = $('#register-button-message');
        register_button.html('Registering ...');

        var register_button_icon = $('#register-button-icon');
        register_button_icon.removeClass('fa-arrow-right').addClass('fa-circle-o-notch fa-spin');

        // Store variable's values on datastore
        $.ajax({
            type: "POST",
            url: "/register",
            data: {
                email: email,
                password: password,
                name: name,
                role: role,
                business: business,
                sensor_data: sensor_data
            },
            success: function (response) {
                $('.modal-body').html(response['html']);
                $('#register-button').css('display', 'none');
            },
            error: function (response) {
                var ajax_errors = $('#ajax-errors');
                // response.responseJSON will access the JSON object inside the response (sent by the server).
                var title = response.responseJSON['title'];
                var message = response.responseJSON['message'];

                ajax_errors.css('display', 'block');
                ajax_errors.find('strong').html(title);
                ajax_errors.find('span').html(message);
            },
            complete: function () {
                register_button.html('Register');
                register_button_icon.removeClass('fa-circle-o-notch fa-spin').addClass('fa-arrow-right');
            }
        })
    });

    // By reloading th page, we reset the registration modal to its original layout.
    $('#modal-close-button').click(function () {
        location.reload();
    });

</script>